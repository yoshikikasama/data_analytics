# ビッグデータ分析・活用のためのSQLレシピ

## 概要

このアーカイブに含まれるファイルは、『ビッグデータ分析・活用のためのSQLレシピ』（マイナビ出版）に掲載されている各種テーブル定義など、サンプルデータです。

「Chapter3」〜「Chapter8」までのフォルダに、各章内で使用するサンプルデータを項別に配置しています（Chapter1とChapter2、Chapter9のサンプルデータはありません）。同一のテーブルを別の項で使用する場合でも、項ごとに動作確認ができるように重複してデータを保持しています。

なお、ここで提供するデータは本書で紹介するクエリを動作確認するためのダミーデータであるため、本書内での出力結果とは必ずしも一致しません。予めご了承ください。

## MEMO

- GROUP BY
  - SELECT句に指定できるカラムはGROUP BY句に指定したカラムか集約関数(SUM,COUNT,AVG..)のみ。
  - GROUP BY句を使用したクエリでは、GROUP BY句に指定したカラムをユニークキーとして、新たなテーブルが作られます。その過程でGROUP BY句に指定していないカラムの値は失われるため。

- ウィンドウ関数の基本構成
  - テーブルの中でウィンドウと呼ばれるある種の範囲を定義し、その範囲内に含まれる値を特定のレコードから自由に利用できるように定義したもの。
- ウィンドウ関数の基本的な形は以下のようになります：

```sql
  関数名(列名) OVER (PARTITION BY 列名 ORDER BY 列名)
```

- OVER キーワードを使って、どの範囲で集約や計算を行うかを指定します。
- PARTITION BY: データを特定の範囲（パーティション）に分けて処理します。たとえば user_id でパーティションを分ければ、ユーザーごとに計算を行います。
- ORDER BY: パーティション内での並び順を指定します。これがあると、ランキング関数なども使えます。
- ウィンドウ関数の例
  - 以下、ウィンドウ関数を使って平均スコアをユーザーごとに計算する例です。

```sql
SELECT
    user_id,
    score,
    AVG(score) OVER (PARTITION BY user_id) AS user_avg_score
FROM
    review;
```

- このクエリは次のことをしています：
  - PARTITION BY user_id で、ユーザーごとにデータを分けています。
  - AVG(score) は、各ユーザーの平均スコアを計算します。
  - 結果として、user_id が同じ行すべてに同じ user_avg_score が表示されます。
  - なぜウィンドウ関数が便利か？
    - 通常、集約関数を使うと GROUP BY と一緒に使う必要があり、データが「グループ化」されてしまいます。そのため、詳細な行データを失うことがあります。ウィンドウ関数を使えば、各行に対して集約データ（たとえば平均値など）を「そのまま」表示できるので、元のデータと集約結果を同時に扱えます。

- ROWS BETWEEN ... AND ...
  - ウィンドウ関数の集計範囲を指定するために使います。ウィンドウ関数が適用される際に、「どの範囲のデータを含めて計算するか」を制御できます。
  - ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
  - 意味: 最初の行から現在の行までのすべての行を範囲に含む。
  - 用途: 累積計算（例えば、現在の行までの累積合計や累積平均）に便利です。
- UNBOUNDED PRECEDING
  - 「無限に前の行」＝つまり、テーブルの最初の行から
- UNBOUNDED FOLLOWING
  - 「無限に後の行」＝つまり、テーブルの最後の行まで。
- n PRECEDING
  - n行前
- n FOLLOWING
  - n行後
- 
